node {
    checkout scm
    withEnv(['HOME=.']) {          
        docker.image('docker:24-dind').withRun('-p 2376:2375 --privileged -e DOCKER_TLS_CERTDIR=""') { c ->
            // Dynamic check for Dind-Daemon readiness
            script {
                def dindReady = false
                echo "Waiting for Dind-Daemon..."

                for (int i = 0; i < 60; i++) {
                    try {
                        sh "docker --host tcp://localhost:2376 info > /dev/null 2>&1"
                        echo "Dind-Daemon is ready!"
                        dindReady = true
                        break 
                    } catch (Exception e) {
                        echo "Dind-Daemon is not ready yet, trying again in 1 second... (${i+1}/60)"
                        sleep 1 
                    }
                }

                if (!dindReady) {
                    error "Dind-Daemon is not ready in the expected timeframe."
                }
            }
            //Start the Docker CLI inside the Dind container
            docker.image("${env.DOCKER_IMAGE_CLI}").inside("--link ${c.id}:docker --privileged -u root") {
                stage ('Build') {
                    sh """
                        cd src/app
                        export DOCKER_HOST=tcp://docker:2375
                        docker-compose build
                        docker images
                        cd ..
                    """
                }
                // Push the image to the registry
                stage ('Upload') {
                     sh """
                        export DOCKER_HOST=tcp://docker:2375
                        cp -RT src/app /app/src/workspace
                        cd /app/src/workspace
                        ie-app-publisher-linux de c -u http://docker:2375
                        export IE_SKIP_CERTIFICATE=true
                        ie-app-publisher-linux em li -u "$IEM_URL" -e $USER_NAME -p $PSWD
                        ie-app-publisher-linux em app cuv -a $APP_ID -v 0.0.$BUILD_NUMBER -y ./docker-compose.prod.yml -n '{"hello-edge":[{"name":"hello-edge","protocol":"HTTP","port":"80","headers":"","rewriteTarget":"/"}]}' -s 'hello-edge' -t 'FromBoxReverseProxy' -u "hello-edge" -r "/"
                        ie-app-publisher-linux em app uuv -a $APP_ID -v 0.0.$BUILD_NUMBER
                        
                        # ENTFERNT: ie-app-publisher-linux em app pv (da es 'unknown option -a' Fehler verursacht)
                        # Die App-Version sollte nach uuv in der UI sichtbar sein.
                        
                        echo "Waiting 15 seconds for IEM to process the upload..."
                        sleep 15 # Wartezeit nach dem Upload
                     """
                }  

                //Moeglich CLI Schnittstelle fuer automatischen Upload einzubauen.
                // Erst Waittimer dann der CLI push auf das IEVD
                //CLI Doku ist unter der edge doku schau im dateibau links und durchblaettern

                                /* Deploy to given edge device */
                stage ('Deploy to Device') {
                    script {
                        sh '''#!/bin/bash
                            set -x # Debug-Ausgabe aktivieren (kann entfernt werden, wenn alles funktioniert)

                            # NEUE ZEILE: IE_SKIP_CERTIFICATE für diese Shell-Session setzen
                            export IE_SKIP_CERTIFICATE=true

                            # Konfiguriere die Basis-URL deines IEM
                            IEM_BASE_URL="https://192.168.56.4:443"

                            # Definition des Authentifizierungs-Endpunkts
                            IEM_AUTH_URL="\$IEM_BASE_URL/portal/api/v1/login/direct"

                            # Temporäre Datei für curl-Ausgaben (für Auth)
                            AUTH_CURL_OUTPUT_FILE="auth_curl_response.txt"

                            # --- SCHRITT 1: Access Token für IEM API abrufen ---
                            echo "--- Attempting to get IEM Access Token ---"
                            curl -s -X POST -H "Content-Type: application/json" -d '{"username":"'"${USER_NAME}"'","password":"'"${PSWD}"'"}' --insecure -L "\$IEM_AUTH_URL" > "\$AUTH_CURL_OUTPUT_FILE" 2>&1
                            
                            CURL_EXIT_CODE=\$?
                            if [ "\$CURL_EXIT_CODE" -ne 0 ]; then
                                echo "ERROR: curl command for authentication failed with exit code \$CURL_EXIT_CODE."
                                echo "Curl output:"
                                cat "\$AUTH_CURL_OUTPUT_FILE"
                                exit 1
                            fi

                            echo "--- Raw CURL Response (from authentication) ---"
                            cat "\$AUTH_CURL_OUTPUT_FILE"
                            echo "-----------------------------------------------"

                            # Extrahiere den Access Token aus der JSON-Antwort
                            IEM_TOKEN=\$(cat "\$AUTH_CURL_OUTPUT_FILE" | jq -r .data.access_token)

                            # Überprüfung, ob der Token erfolgreich extrahiert wurde
                            if [ -z "\$IEM_TOKEN" ] || [ "\$IEM_TOKEN" == "null" ]; then
                                echo "ERROR: Failed to get IEM access_token. Check credentials, IEM URL, and CURL response."
                                echo "The response did not contain a valid access_token or authentication failed."
                                exit 1
                            fi

                            echo "Successfully obtained IEM access_token."
                            echo "IEM_TOKEN (first 10 chars): \$(echo \$IEM_TOKEN | cut -c 1-10)..."


                            # --- SCHRITT 2: Industrial Edge Application ID verwenden ---
                            echo "Using Application ID: \$APP_ID"


                            # --- SCHRITT 3: Device ID verwenden ---
                            DEVICE_ID="\$EDGE_DEVICE_ID" # <-- VERWENDET DIE VARIABLE $EDGE_DEVICE_ID
                            echo "Using Device ID: \$DEVICE_ID"

                            # --- SCHRITT 4: Anwendungsversion definieren ---
                            APP_VERSION="0.0.\$BUILD_NUMBER" # <-- Verwendet BUILD_NUMBER aus Jenkins
                            echo "Attempting to deploy Application Version: \$APP_VERSION"


                            # --- KORRIGIERTER DIAGNOSE-SCHRITT: App-Details über CLI abfragen ---
                            echo "--- Verifying App Version Status via ie-app-publisher-linux em app detail ---"
                            # Login mit dem CLI-Tool, da jeder sh-Block eine neue Shell-Session ist
                            ie-app-publisher-linux em li -u "\$IEM_BASE_URL" -e "\$USER_NAME" -p "\$PSWD"
                            
                            # App-Details abrufen (sollte JSON zurückgeben)
                            # Wir verwenden 'detail -a' Option, da es die logischste Wahl ist.
                            APP_DETAILS_CLI_RESPONSE=\$(ie-app-publisher-linux em app detail -a "\$APP_ID")
                            echo "Raw App Details CLI Response:"
                            echo "\$APP_DETAILS_CLI_RESPONSE" | jq . # Pretty print the JSON
                            echo "-------------------------------------------------------------------"

                            # Überprüfen, ob die gewünschte Version und ihr Status vorhanden sind
                            # Der jq-Filter muss die JSON-Struktur des 'detail'-Outputs kennen
                            VERSION_STATUS=\$(echo "\$APP_DETAILS_CLI_RESPONSE" | jq -r '.appVersions[] | select(.versionNumber=="'"\$APP_VERSION"'") | .status')

                            if [ -z "\$VERSION_STATUS" ] || [ "\$VERSION_STATUS" == "null" ]; then
                                echo "ERROR: App version \$APP_VERSION not found in app details or has no status."
                                echo "This is unexpected. Check IEM UI for version details."
                                exit 1
                            else
                                echo "Confirmed: Version \$APP_VERSION found in IEM with status: \$VERSION_STATUS"
                                # Hier kannst du prüfen, ob der Status "Published" oder "Reviewed" ist
                                if ! echo "\$VERSION_STATUS" | grep -qE "Published|Reviewed|Released"; then
                                    echo "WARNING: App version \$APP_VERSION is not in a deployable state (Published/Reviewed/Released)."
                                    exit 1
                                fi
                            fi


                            # --- SCHRITT 5: Anwendung auf dem Edge Device deployen ---
                            echo "--- Attempting to deploy application \$APP_ID version \$APP_VERSION to device \$DEVICE_ID ---"
                            
                            # Temporäre Datei für curl-Ausgaben (für Deployment)
                            DEPLOY_CURL_OUTPUT_FILE="deploy_curl_response.txt"

                            curl -s -X POST \\
                                                -H "Authorization: Bearer \$IEM_TOKEN" \\
                                                -H "Content-Type:multipart/form-data" \\
                                                -F 'infoMap={"devices":["'"\$DEVICE_ID"'"]}' \\
                                                --insecure \\
                                                "\$IEM_BASE_URL/portal/api/v1/batches?appid=\$APP_ID&operation=installApplication&version=\$APP_VERSION" > "\$DEPLOY_CURL_OUTPUT_FILE" 2>&1
                            
                            CURL_EXIT_CODE=\$?
                            if [ "\$CURL_EXIT_CODE" -ne 0 ]; then
                                echo "ERROR: Deployment curl command failed with exit code \$CURL_EXIT_CODE."
                                echo "Deployment response:"
                                cat "\$DEPLOY_CURL_OUTPUT_FILE"
                                exit 1
                            fi

                            echo "--- Raw Deployment Response ---"
                            cat "\$DEPLOY_CURL_OUTPUT_FILE"
                            echo "-------------------------------"

                            # Optional: Überprüfe die Deployment-Antwort auf Erfolg oder Status
                            echo "Application deployment request sent successfully."
                        '''
                    }
                }

 //*/
            }        
        }
    }
}