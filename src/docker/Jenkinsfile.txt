node {
    checkout scm
    withEnv(['HOME=.']) {          
        docker.image('docker:24-dind').withRun('-p 2376:2375 --privileged -e DOCKER_TLS_CERTDIR=""') { c ->
            // Dynamic check for Dind-Daemon readiness
            script {
                def dindReady = false
                echo "Waiting for Dind-Daemon..."

                for (int i = 0; i < 60; i++) {
                    try {
                        // Tries to connect to the Dind-Daemon
                        // 'localhost:2375' is the port where the Docker daemon is exposed. Look at line 4
                        // '> /dev/null 2>&1' redircets output to avoid cluttering the logs
                        sh "docker --host tcp://localhost:2376 info > /dev/null 2>&1"
                        echo "Dind-Daemon is ready!"
                        dindReady = true
                        break 
                    } catch (Exception e) {//Dind-Daemon wasn't ready for another second
                        echo "Dind-Daemon is not ready yet, trying again in 1 second... (${i+1}/60)"
                        sleep 1 
                    }
                }

                if (!dindReady) { // throws error if dind is not ready after 60 seconds
                    error "Dind-Daemon is not ready in the expected timeframe."
                }
            }
            //Start the Docker CLI inside the Dind container
            docker.image("${env.DOCKER_IMAGE_CLI}").inside("--link ${c.id}:docker --privileged -u root") {
                stage ('Build') {
                    sh """
                        cd src/app
                        export DOCKER_HOST=tcp://docker:2375
                        docker-compose build
                        docker images
                        cd ..
                    """
                }
                // Push the image to the registry
                stage ('Upload') {
                     sh """
                        export DOCKER_HOST=tcp://docker:2375
                        cp -RT src/app /app/src/workspace
                        cd /app/src/workspace
                        ie-app-publisher-linux de c -u http://docker:2375
                        export IE_SKIP_CERTIFICATE=true
                        ie-app-publisher-linux em li -u "$IEM_URL" -e $USER_NAME -p $PSWD
                        ie-app-publisher-linux em app cuv -a $APP_ID -v 0.0.$BUILD_NUMBER -y ./docker-compose.prod.yml -n '{"hello-edge":[{"name":"hello-edge","protocol":"HTTP","port":"80","headers":"","rewriteTarget":"/"}]}' -s 'hello-edge' -t 'FromBoxReverseProxy' -u "hello-edge" -r "/"
                        ie-app-publisher-linux em app uuv -a $APP_ID -v 0.0.$BUILD_NUMBER
                     """
                }  
                /* Deploy to given edge device */
                stage ('Deploy to Device') {
                    sh """
                        # 1. Get Access Token (example, replace with actual IEM API auth)
                        IEM_TOKEN=\$(curl -s -X POST -H "Content-Type: application/json" -d '{"username":"$USER_NAME","password":"$PSWD"}' "$IEM_URL/api/v1/auth/login" | jq -r .token)

                        if [ -z "\$IEM_TOKEN" ]; then
                            echo "Failed to get IEM token."
                            exit 1
                        fi

                        # 2. Find Device ID (example, replace with actual IEM API call)
                        # You might need to query for the device by name or serial number
                        #DEVICE_ID="your_target_device_id_from_iem" # This needs to be fetched dynamically or configured


                        DEVICE_ID="529662ec59c247e29812a8f2dd824640" # This needs to be fetched dynamically or configured

                        # 3. Find App ID and Version (you already have APP_ID and BUILD_NUMBER)
                        APP_VERSION="0.0.$BUILD_NUMBER"

                        # 4. Create/Update Deployment (example, replace with actual IEM API call)
                        # This is the most complex part, as it involves creating a deployment plan
                        # or assigning the app to the device.
                        # You would typically send a POST request to an endpoint like /api/v1/deployments
                        # with a JSON payload specifying the device, app, and version.

                        # Example: Triggering a deployment (highly simplified and conceptual)
                        curl -X POST -H "Authorization: Bearer \$IEM_TOKEN" \\
                            -H "Content-Type: application/json" \\
                            -d '{
                                "deviceId": "\529662ec59c247e29812a8f2dd824640",
                                "applicationId": "$APP_ID",
                                "applicationVersion": "\$APP_VERSION",
                                "action": "deploy"
                                }' \\
                            "$IEM_URL/api/v1/deployments"

                        echo "Deployment triggered for device \$DEVICE_ID with app $APP_ID version \$APP_VERSION"
                    """
                }
            }        
        }
    }
}